<!-- b6263377-7a9b-4e86-ad5b-d87126e381cc cb4ec72b-b118-4e20-9e44-3d556b0c7a80 -->
# Symbol UUID Refactor Plan

## Phase 0 â€“ Discovery & Design *(complete)*

- âœ… Reviewed migration history and regenerated `types/database.types.ts` to confirm the UUID schema.
- âœ… Updated `docs/SYMBOL-UUID-PLAN.md` with the final ER changes and rollout notes.
- âœ… Catalogued downstream ticker consumers across `server/`, `app/`, and `components/` (positions CRUD/import/export, market data, quotes/dividends, news, analytics, AI tooling).

## Phase 1 â€“ Database Migrations & Backfill *(complete)*

- âœ… Added UUID primary key to `symbols`, renamed the legacy text key to `ticker`, and rebuilt dependent constraints/indexes.
- âœ… Introduced `symbol_aliases` with primary-alias guard, sync trigger to `symbols.ticker`, and read-only RLS for clients.
- âœ… Converted `news.related_symbol_ids` to UUID arrays while preserving ordering and index coverage.

## Phase 2 â€“ Tooling & Types *(complete)*

- âœ… Regenerated Supabase types and verified generated files reflect the new schema.
- ðŸ”„ Refresh Zod schemas/shared helpers that still expect ticker IDs (to be finalized during server/client refactors).
- âœ… Noted fixtures/tests impacted by the UUID switchover for follow-up once logic changes land.

## Phase 3 â€“ Resolver Layer & Server Refactor *(in progress)*

- Implement `server/symbols/resolver.ts` with core helpers:
- `resolveSymbolInput(input: string, source?: string)` â†’ canonical UUID + alias metadata.
- `getCanonicalSymbol(id: string)` â†’ `symbols` row plus primary alias.
  - `getProviderSymbolAlias(id: string, source: string)` â†’ provider-specific identifier (e.g., Yahoo ticker).
  - `getProviderSymbolAlias(id: string, source: string)` â†’ provider-specific identifier (e.g., Yahoo ticker).
  - `setPrimarySymbolAlias(symbolId: string, aliasValue: string, source: string)` â†’ promotes alias and syncs `symbols.ticker`.
- Replace `createSymbol` with a resolver-backed workflow (symbol alias upsert, metadata refresh, primary symbol alias management).
- Refactor server modules to rely solely on UUIDs + resolver outputs (no ticker fallbacks):
- Positions CRUD/import/export and snapshots (`server/positions/*`, CSV pipeline in `lib/import`).
- Quotes, dividends, and market data fetchers (`server/quotes/fetch.ts`, `server/market-data/**`, `server/dividends/fetch.ts`, analytics helpers, cron routes).
- News ingestion/caching (`server/news/fetch.ts`) using UUID lists and resolver surrogates when calling Yahoo.
- AI tools and analytics modules that currently surface `symbol_id` strings.

## Phase 4 â€“ Client & API Updates *(queued)*

- Update UI forms/components to submit UUIDs while displaying the current ticker (dashboard creation flows, import review tables, asset detail pages).
- Ensure CSV import/export surfaces ticker text for users but reads/writes UUID internally.
- Audit hooks/utilities for ticker assumptions and align with resolver return shapes (e.g., `{ id, ticker, aliases }`).

## Phase 5 â€“ Testing, Verification & Rollout *(queued)*

- Expand automated tests for resolver behaviour (alias lookup, rename promotion, provider alias retrieval).
- Re-run staging smoke tests covering migrations, position workflows, market data jobs, analytics dashboards, and AI features.
- Document deployment + rollback checklist and communicate changes to contributors ahead of production rollout.

### To-dos

- [x] Finalize schema changes and downstream dependency inventory for symbols UUID refactor.
- [x] Implement migrations for UUID primary keys, alias table, and foreign key backfills.
- [x] Regenerate Supabase types and update shared TS/Zod definitions for symbols and aliases.
- [ ] Create resolver module and update server data flows to use UUID-based symbol lookups.
- [ ] Update client/UI layers, CSV tooling, and tests; perform staging verification and rollout prep.