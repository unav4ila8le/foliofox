---
description: Project specifications and technical overview for Foliofox
globs:
alwaysApply: false
---

Foliofox - Project Details (Positions Architecture)

## Overview

Foliofox is a privacy-focused portfolio intelligence and net worth tracking app. Users can track assets, liabilities, and net worth over time with multi-currency support and clear visualizations. The app is designed for personal use, with future extensibility in mind, including AI for portfolio advisory.

## Tech Stack

- **Framework:** Next.js 15 (App Router)
- **Language:** TypeScript (strict mode)
- **Database:** Supabase (Postgres, Auth)
- **Styling:** Tailwind CSS, Shadcn UI
- **Charting:** Recharts
- **External Data:** Yahoo Finance v3 (quotes), Frankfurter API (FX)
- **Deployment & Jobs:** Vercel, Vercel Cron

## Core Principles

- **Privacy:** No third-party data sharing or scraping.
- **Simplicity:** Minimal, modular UI. Logic and calculations are prioritized over design.
- **Extensible:** Codebase and data model are designed for future features and scaling.

## Key Features

- Track net worth over time with interactive charts (1m, 3m, 6m, YTD)
- Multi-currency with daily exchange rates (one-day data lag)
- Manual entry and market-priced positions via symbols
- CSV import/export with strict validation and helpful errors
- Archive and restore positions
- Secure authentication and user profiles
- Modular, type-safe codebase

## Data Model (Simplified)

- **Positions:** Unified table for assets and liabilities (`type: 'asset' | 'liability'`), joined to `position_categories` and optionally to `position_sources`
- **Portfolio Records:** Unified actions (`buy`, `sell`, `update`) ordered by `(date, created_at)`
- **Position Snapshots:** Daily quantity/unit_value/basis; recalculated from a start date until the next `update` record
- **Position Sources Hub:** `position_sources` (type), `source_symbols(symbol_id)`, `source_domains(domain_id)`
- **Quotes:** Daily prices keyed by `symbol_id|date` (cached)
- **Exchange Rates:** Daily USD-base FX rates cached by target currency and date
- **Profiles, Asset Categories, Currencies:** User profile and reference data

Notes:

- Store all dates in UTC. Handle all monetary values as numbers; format only for display.
- FX uses USD as base for caching and conversion.
- Market data aggregator is pluggable via handler registry; prefer bulk fetching with DB upsert enabled.

## Development Guidelines

- Follow `global-rules.mdc` for architecture, code style, and file structure.
- Prefer React Server Components; use Client Components only for browser APIs.
- Keep server actions in `server/` with `"use server"`.
- Use user-scoped Supabase client from `supabase/server.ts`; reserve `supabase/service.ts` (service role; bypasses RLS) for cron/admin tasks.
- Prefer using `fetchPositions()` and `fetchSinglePosition()` wrappers for portfolio reads.
- Use Zod for data validation.
- Use ISO currency codes (USD, EUR, etc.) throughout.

## Market & FX Data

- Daily updates via cron endpoints `app/api/cron/fetch-quotes` and `app/api/cron/fetch-exchange-rates`, authorized with `Authorization: Bearer ${CRON_SECRET}`.
- Refresh target: 22:00 UTC; UI indicates a oneâ€‘day delay.
- Bulk fetching and DB caching: missing quotes/FX are fetched in batches and upserted for reuse by analysis.
- In-app valuation (`fetchPositions({ asOfDate })`) fetches bulk prices via `server/market-data/fetch.fetchMarketData()`; default to `upsert: true` to populate cache.

## Not in Scope (MVP)

- No automatic bank or brokerage integrations
- No expense tracking or budgeting features
- No real-time data feeds (daily refreshes; no WebSockets)

## For More Details

- See `README.md` for setup and utility function cheatsheets.
- See `global-rules.mdc` for code conventions and architecture.
